using Pkg
# ะะปั ัะพะทะดะฐะฝะธั ะธ ะพะฑััะตะฝะธั ะฝะตะนัะพะฝะฝัั ัะตัะตะน.
Pkg.add(PackageSpec(name="Flux", version="0.14.25"))
# ะะปั ะผะพะดะตะปะธัะพะฒะฐะฝะธั ะธ ัะตัะตะฝะธั ะดะธััะตัะตะฝัะธะฐะปัะฝัั ััะฐะฒะฝะตะฝะธะน
Pkg.add(PackageSpec(name="DifferentialEquations", version="7.15.0"))
# ะะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะดะธััะตัะตะฝัะธัะพะฒะฐะฝะธั ะฒ ะทะฐะดะฐัะฐั, ัะฒัะทะฐะฝะฝัั ั ะผะพะดะตะปะธัะพะฒะฐะฝะธะตะผ.
Pkg.add(PackageSpec(name="SciMLSensitivity", version="7.72.0"))
# ะะปั ะผะตัะพะดะพะฒ ะพะฟัะธะผะธะทะฐัะธะธ
Pkg.add(PackageSpec(name="Optimisers", version="0.3.4"))
Pkg.add("BSON")
Pkg.status()
using Optimisers
using SciMLSensitivity
using DifferentialEquations
using Flux
using Random
using BSON

# ะะฐัะฐะผะตััั ะผะฐััะฝะธะบะฐ.
m = Float32(0.2)   # ะะฐััะฐ ัะฐัะธะบะฐ (ะบะณ).
M = Float32(0.5)   # ะะฐััะฐ ัะตะปะตะถะบะธ (ะบะณ).
L = Float32(0.3)   # ะะปะธะฝะฐ ะผะฐััะฝะธะบะฐ (ะผ).
g = Float32(9.81)  # ะฃัะบะพัะตะฝะธะต ัะฒะพะฑะพะดะฝะพะณะพ ะฟะฐะดะตะฝะธั (ะผ/ั^2).


#= 
ะฃัะฐะฒะฝะตะฝะธั ะดะฒะธะถะตะฝะธั. ะะฟะธััะฒะฐะตั ะดะธะฝะฐะผะธัะตัะบัั ะผะพะดะตะปั ัะธััะตะผั "ะผะฐััะฝะธะบ ะฝะฐ ัะตะปะตะถะบะต" 
ะฒ ะฒะธะดะต ััะฐะฒะฝะตะฝะธะน ะดะฒะธะถะตะฝะธั.

ะัะณัะผะตะฝัั:
du: ะะตะบัะพั, ะบัะดะฐ ะทะฐะฟะธััะฒะฐัััั ะฟัะพะธะทะฒะพะดะฝัะต ะฟะฐัะฐะผะตััะพะฒ (ัะตะทัะปััะฐั ะฒััะธัะปะตะฝะธะน).
    ะะฐะฟัะธะผะตั, du = [dฮธ, dฯ, dx, dv], ะณะดะต:
    ๐ฮธ/๐๐ก = ฯ,
    ๐๐/๐๐ก = ัะณะปะพะฒะพะตยััะบะพัะตะฝะธะตยะผะฐััะฝะธะบะฐ,
    ๐๐ฅ/๐๐ก = ๐ฃ,
    ๐๐ฃ/๐๐ก = ะปะธะฝะตะนะฝะพะตยััะบะพัะตะฝะธะตยัะตะปะตะถะบะธ.
u:  ะะตะบัะพั ัะตะบััะตะณะพ ัะพััะพัะฝะธั ัะธััะตะผั, ัะพะดะตัะถะฐัะธะน:
    ฮธ โ ัะณะพะป ะผะฐััะฝะธะบะฐ ะพัะฝะพัะธัะตะปัะฝะพ ะฒะตััะธะบะฐะปะธ (ะฒ ัะฐะดะธะฐะฝะฐั).
    ฯ โ ัะณะปะพะฒัั ัะบะพัะพััั ะผะฐััะฝะธะบะฐ (ัะฐะด/ั).
    x โ ะฟะพะปะพะถะตะฝะธะต ัะตะปะตะถะบะธ (ะผ).
    v โ ะปะธะฝะตะนะฝัั ัะบะพัะพััั ัะตะปะตะถะบะธ (ะผ/ั). 
p:  ะะฐัะฐะผะตััั ะฒะฝะตัะฝะตะณะพ ะฒะพะทะดะตะนััะฒะธั. ะะดะตัั ััะพ ะฒะตะบัะพั ั ะตะดะธะฝััะฒะตะฝะฝัะผ ัะปะตะผะตะฝัะพะผ:
    force (๐น) โ ัะธะปะฐ, ะฟัะธะปะพะถะตะฝะฝะฐั ะบ ัะตะปะตะถะบะต.
t:  ะัะตะผั. ะ ะดะฐะฝะฝะพะผ ัะปััะฐะต ะฒัะตะผั ัะฒะฝะพ ะฝะต ะธัะฟะพะปัะทัะตััั ะฒ ััะฐะฒะฝะตะฝะธัั, ะฝะพ ะฟะตัะตะดะฐะตััั 
    ะดะปั ัะพะฒะผะตััะธะผะพััะธ ั ัะธัะปะตะฝะฝัะผะธ ะผะตัะพะดะฐะผะธ ัะตัะตะฝะธั ะะะฃ (ะพะฑัะบะฝะพะฒะตะฝะฝัะต ะดะธััะตัะตะฝัะธะฐะปัะฝัะต 
    ััะฐะฒะฝะตะฝะธั).
=#
function cartpole!(du, u, p, t)
    # ะะท ะฒะตะบัะพัะฐ ัะตะบััะตะณะพ ัะพััะพัะฝะธั ะธะทะฒะปะตะบะฐัััั ะทะฝะฐัะตะฝะธั ัะณะปะฐ, ัะณะปะพะฒะพะน ัะบะพัะพััะธ, ะฟะพะปะพะถะตะฝะธั ะธ ัะบะพัะพััะธ.
    ฮธ, ฯ, x, v = u
    force = p[1]  # ัะธะปะฐ, ะบะพัะพัะฐั ะฑัะดะตั ะฟัะธะผะตะฝะตะฝะฐ ะบ ัะตะปะตะถะบะต

    # ะฃัะฐะฒะฝะตะฝะธั ะดะฒะธะถะตะฝะธั.
    # ะฃะณะปะพะฒะฐั ัะบะพัะพััั ะผะฐััะฝะธะบะฐ ๐ ัะฒะปัะตััั ะฟัะพะธะทะฒะพะดะฝะพะน ัะณะปะฐ ๐ (๐๐/๐๐ก=ฯ).
    dฮธ = ฯ
    
    # ะะธะฝะตะนะฝะฐั ัะบะพัะพััั ัะตะปะตะถะบะธ ๐ฃ ัะฒะปัะตััั ะฟัะพะธะทะฒะพะดะฝะพะน ะฟะพะปะพะถะตะฝะธั ๐ฅ (๐๐ฅ/๐๐ก=๐ฃ).
    dx = v

    # ะะธะฝะตะนะฝะพะต ััะบะพัะตะฝะธะต ัะตะปะตะถะบะธ (๐๐ฃ/๐๐ก).
    dv = (m * g * sin(ฮธ) * cos(ฮธ) - 7 / 3 * (force + m * L / 2 * ฯ^2 * sin(ฮธ)))/(m * cos(ฮธ)^2 - 7 /3 * M)
    #= 
    ะฃะณะปะพะฒะพะต ััะบะพัะตะฝะธะต ะผะฐััะฝะธะบะฐ (๐๐/๐๐ก), ะทะฐะฒะธัะธั ะพั:
    ัะธะปั ััะถะตััะธ (๐), 
    ัะณะปะฐ ะผะฐััะฝะธะบะฐ (sin(๐)), 
    ะบะพะผะฟะพะฝะตะฝัั ะปะธะฝะตะนะฝะพะณะพ ััะบะพัะตะฝะธั ัะตะปะตะถะบะธ (๐๐ฃ), ะบะพัะพัะฐั ะฒะปะธัะตั ะฝะฐ ะดะฒะธะถะตะฝะธะต ะผะฐััะฝะธะบะฐ ัะตัะตะท ัะธะปั ัะตะฐะบัะธะธ.
    =#
    dฯ = 3 / (7L / 2) * (g * sin(ฮธ) - dv * cos(ฮธ))

    # ะะฐะฟะธัั ะฟัะพะธะทะฒะพะดะฝัั ะฒ du.
    du[1] = dฮธ
    du[2] = dฯ
    du[3] = dx
    du[4] = dv
end

#ะะฐะณััะถะฐะตะผ ะผะพะดะตะปั
model_path = "model.bson"
BSON.@load model_path model
println("ะะพะดะตะปั ะทะฐะณััะถะตะฝะฐ ะธะท $model_path")

u0 = Float32[pi/6, 0, 0, 0]
test_model(model, u0)