using Pkg
# Ð”Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¸ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð½ÐµÐ¹Ñ€Ð¾Ð½Ð½Ñ‹Ñ… ÑÐµÑ‚ÐµÐ¹.
#Pkg.add(PackageSpec(name="Flux", version="0.14.25"))
# Ð”Ð»Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð´Ð¸Ñ„Ñ„ÐµÑ€ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑƒÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ð¹
#Pkg.add(PackageSpec(name="DifferentialEquations", version="7.15.0"))
# Ð”Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´Ð¸Ñ„Ñ„ÐµÑ€ÐµÐ½Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² Ð·Ð°Ð´Ð°Ñ‡Ð°Ñ…, ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ñ… Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼.
#Pkg.add(PackageSpec(name="SciMLSensitivity", version="7.72.0"))
# Ð”Ð»Ñ Ð¼ÐµÑ‚Ð¾Ð´Ð¾Ð² Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸
#Pkg.add(PackageSpec(name="Optimisers", version="0.3.4"))
# Ð”Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¼Ð¾Ð´ÐµÐ»Ð¸
#Pkg.add("BSON")
# Ð”Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¾Ð²
#Pkg.add("Plots")
#Pkg.status()
using Optimisers
using SciMLSensitivity
using DifferentialEquations
using Flux
using Random
using BSON
using Plots

# ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ°.
m = Float32(0.2)   # ÐœÐ°ÑÑÐ° ÑˆÐ°Ñ€Ð¸ÐºÐ° (ÐºÐ³).
M = Float32(0.5)   # ÐœÐ°ÑÑÐ° Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸ (ÐºÐ³).
L = Float32(0.3)   # Ð”Ð»Ð¸Ð½Ð° Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ° (Ð¼).
g = Float32(9.81)  # Ð£ÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ðµ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¿Ð°Ð´ÐµÐ½Ð¸Ñ (Ð¼/Ñ^2).

# ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð°
function quality(teta_arr, p_arr)
    return sum(teta_arr .^ 2 + p_arr .^ 2) * 0.02
end

#= 
Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð±Ð°Ñ‚Ñ‡Ð° (Ð½Ð°Ð±Ð¾Ñ€Ð°) ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ñ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð´Ð»Ñ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸.

ÐÑ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹:
N â€” ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² (Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹) Ð² Ð±Ð°Ñ‚Ñ‡Ðµ.
L â€” Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð´Ð»Ð¸Ð½Ð° Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð° Ð´Ð»Ñ Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸ (Ð² Ð¼ÐµÑ‚Ñ€Ð°Ñ…).
=#
function generate_random_batch(N, L)
    # Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ.
    elements = []
    # ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð¸ÑÐºÑ€ÐµÑ‚Ð½Ñ‹Ñ… Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð´Ð»Ñ 
    # Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ñ… Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹.
    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚, Ð½Ð°ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ Ð´ÐµÐ»Ð¸Ñ‚ÑÑ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ 
    # Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð° (ÑƒÐ³Ð¾Ð», ÑƒÐ³Ð»Ð¾Ð²Ð°Ñ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ, Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ, Ð»Ð¸Ð½ÐµÐ¹Ð½Ð°Ñ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ) 
    # Ð½Ð° Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ‚Ð¾Ñ‡ÐºÐ¸.
    n_values = 20
    # Ð¨Ð°Ð³ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑƒÐ³Ð»Ð° Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ° Ð² Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ðµ [-Ï€/2, Ï€/2].
    angle_step = Ï€ / n_values
    # Ð¨Ð°Ð³ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑƒÐ³Ð»Ð¾Ð²Ð¾Ð¹ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸ Ð² Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ðµ [-100, 100].
    Ï‰_step = 100 * 2 / n_values
    # Ð¨Ð°Ð³ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸ Ð² Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ðµ [-L, L].
    x_step = L * 2 / n_values
    #v_step = 100*2/n_values

    # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹ ÑƒÐ³Ð»Ð° Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ° Ð¾Ñ‚ -Ï€/2 Ð´Ð¾ Ï€/2 Ñ ÑˆÐ°Ð³Ð¾Ð¼ angle_step.
    angle_values = collect(-Ï€/2 : angle_step : Ï€/2)
    # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹ ÑƒÐ³Ð»Ð¾Ð²Ð¾Ð¹ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ -100 Ð´Ð¾ 100 Ñ ÑˆÐ°Ð³Ð¾Ð¼ Ï‰_step.
    Ï‰_values = collect(-100 : Ï‰_step : 100)
    # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹ Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸ Ð¾Ñ‚ -L Ð´Ð¾ L Ñ ÑˆÐ°Ð³Ð¾Ð¼ x_step.
    x_values = collect(-L : x_step : L)

    # Ð¦Ð¸ÐºÐ» Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÐµÑ‚ÑÑ N Ñ€Ð°Ð· (Ð¿Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ñƒ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð² Ð±Ð°Ñ‚Ñ‡Ðµ).
    for _ in 1:N
        # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸.

        # Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾ Ð¸Ð· Ð¼Ð°ÑÑÐ¸Ð²Ð°.
        rand_angle = rand(angle_values)
        rand_Ï‰ = rand(Ï‰_values)
        rand_x = rand(x_values)
        #v[-100 100] 
        rand_v = rand(Ï‰_values)
        
        # Ð’ÐµÐºÑ‚Ð¾Ñ€ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ u0 Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ Float32:
        # rand_angle: Ð£Ð³Ð¾Ð» Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ°.
        # rand_Ï‰: Ð£Ð³Ð»Ð¾Ð²Ð°Ñ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ°.
        # rand_x: ÐŸÐ¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸.
        # rand_v: Ð›Ð¸Ð½ÐµÐ¹Ð½Ð°Ñ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸.
        u0 = Float32[rand_angle, rand_Ï‰, rand_x, rand_v]
        # Ð’ÐµÐºÑ‚Ð¾Ñ€ u0 Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ÑÑ Ð² Ð¼Ð°ÑÑÐ¸Ð² elements.
        push!(elements, u0)
    end

    # ÐŸÐ¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… Ð¸Ñ‚ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ñ†Ð¸ÐºÐ» Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¼Ð°ÑÑÐ¸Ð² elements, 
    # ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‰Ð¸Ð¹ N ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ñ… Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹.
    return elements
end

#= 
Ð£Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ. ÐžÐ¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ "Ð¼Ð°ÑÑ‚Ð½Ð¸Ðº Ð½Ð° Ñ‚ÐµÐ»ÐµÐ¶ÐºÐµ" 
Ð² Ð²Ð¸Ð´Ðµ ÑƒÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ð¹ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ.

ÐÑ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹:
du: Ð’ÐµÐºÑ‚Ð¾Ñ€, ÐºÑƒÐ´Ð° Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‚ÑÑ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² (Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð²Ñ‹Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¸Ð¹).
    ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, du = [dÎ¸, dÏ‰, dx, dv], Ð³Ð´Ðµ:
    ð‘‘Î¸/ð‘‘ð‘¡ = Ï‰,
    ð‘‘ðœ”/ð‘‘ð‘¡ = ÑƒÐ³Ð»Ð¾Ð²Ð¾ÐµÂ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸ÐµÂ Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ°,
    ð‘‘ð‘¥/ð‘‘ð‘¡ = ð‘£,
    ð‘‘ð‘£/ð‘‘ð‘¡ = Ð»Ð¸Ð½ÐµÐ¹Ð½Ð¾ÐµÂ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸ÐµÂ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸.
u:  Ð’ÐµÐºÑ‚Ð¾Ñ€ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹, ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‰Ð¸Ð¹:
    Î¸ â€” ÑƒÐ³Ð¾Ð» Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ° Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð²ÐµÑ€Ñ‚Ð¸ÐºÐ°Ð»Ð¸ (Ð² Ñ€Ð°Ð´Ð¸Ð°Ð½Ð°Ñ…).
    Ï‰ â€” ÑƒÐ³Ð»Ð¾Ð²ÑƒÑŽ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ° (Ñ€Ð°Ð´/Ñ).
    x â€” Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸ (Ð¼).
    v â€” Ð»Ð¸Ð½ÐµÐ¹Ð½ÑƒÑŽ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸ (Ð¼/Ñ). 
p:  ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð²Ð½ÐµÑˆÐ½ÐµÐ³Ð¾ Ð²Ð¾Ð·Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ. Ð—Ð´ÐµÑÑŒ ÑÑ‚Ð¾ Ð²ÐµÐºÑ‚Ð¾Ñ€ Ñ ÐµÐ´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð¼:
    force (ð¹) â€” ÑÐ¸Ð»Ð°, Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð½Ð°Ñ Ðº Ñ‚ÐµÐ»ÐµÐ¶ÐºÐµ.
t:  Ð’Ñ€ÐµÐ¼Ñ. Ð’ Ð´Ð°Ð½Ð½Ð¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ Ð²Ñ€ÐµÐ¼Ñ ÑÐ²Ð½Ð¾ Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð² ÑƒÑ€Ð°Ð²Ð½ÐµÐ½Ð¸ÑÑ…, Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÑ‚ÑÑ 
    Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ñ Ñ‡Ð¸ÑÐ»ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¼ÐµÑ‚Ð¾Ð´Ð°Ð¼Ð¸ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ ÐžÐ”Ð£ (Ð¾Ð±Ñ‹ÐºÐ½Ð¾Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð¸Ñ„Ñ„ÐµÑ€ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ 
    ÑƒÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ).
=#
function cartpole!(du, u, p, t)
    # Ð˜Ð· Ð²ÐµÐºÑ‚Ð¾Ñ€Ð° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÑŽÑ‚ÑÑ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ ÑƒÐ³Ð»Ð°, ÑƒÐ³Ð»Ð¾Ð²Ð¾Ð¹ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸, Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð¸ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸.
    Î¸, Ï‰, x, v = u
    force = p[1]  # ÑÐ¸Ð»Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð° Ðº Ñ‚ÐµÐ»ÐµÐ¶ÐºÐµ

    # Ð£Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ.
    # Ð£Ð³Ð»Ð¾Ð²Ð°Ñ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ° ðœ” ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð½Ð¾Ð¹ ÑƒÐ³Ð»Ð° ðœƒ (ð‘‘ðœƒ/ð‘‘ð‘¡=Ï‰).
    dÎ¸ = Ï‰
    
    # Ð›Ð¸Ð½ÐµÐ¹Ð½Ð°Ñ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸ ð‘£ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð½Ð¾Ð¹ Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ ð‘¥ (ð‘‘ð‘¥/ð‘‘ð‘¡=ð‘£).
    dx = v

    # Ð›Ð¸Ð½ÐµÐ¹Ð½Ð¾Ðµ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸ (ð‘‘ð‘£/ð‘‘ð‘¡).
    dv = (m * g * sin(Î¸) * cos(Î¸) - 7 / 3 * (force + m * L / 2 * Ï‰^2 * sin(Î¸)))/(m * cos(Î¸)^2 - 7 /3 * M)
    #= 
    Ð£Ð³Ð»Ð¾Ð²Ð¾Ðµ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ðµ Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ° (ð‘‘ðœ”/ð‘‘ð‘¡), Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚:
    ÑÐ¸Ð»Ñ‹ Ñ‚ÑÐ¶ÐµÑÑ‚Ð¸ (ð‘”), 
    ÑƒÐ³Ð»Ð° Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ° (sin(ðœƒ)), 
    ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ Ð»Ð¸Ð½ÐµÐ¹Ð½Ð¾Ð³Ð¾ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸ (ð‘‘ð‘£), ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð²Ð»Ð¸ÑÐµÑ‚ Ð½Ð° Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ð¼Ð°ÑÑ‚Ð½Ð¸ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· ÑÐ¸Ð»Ñƒ Ñ€ÐµÐ°ÐºÑ†Ð¸Ð¸.
    =#
    dÏ‰ = 3 / (7L / 2) * (g * sin(Î¸) - dv * cos(Î¸))

    # Ð—Ð°Ð¿Ð¸ÑÑŒ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð½Ñ‹Ñ… Ð² du.
    du[1] = dÎ¸
    du[2] = dÏ‰
    du[3] = dx
    du[4] = dv
end


function test_model(model, u0, alg, use_model, print_u=true)
    
    p = [0]
    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¸Ð»Ñƒ Ð¾Ñ‚ Ð¼Ð¾Ð´ÐµÐ»Ð¸.
    if use_model
        p = model(u0)
    end
    
    
    # Ð’Ñ€ÐµÐ¼Ñ Ð²Ð¾Ð·Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ð½Ð° Ñ‚ÐµÐ»ÐµÐ¶ÐºÑƒ.
    tspan = (Float32(0.0), Float32(0.02))
    
    # ÐŸÑ€Ð¸ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð¸ ODEProblem Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð·Ð°Ð´Ð°Ñ‡Ñƒ Ð´Ð¸Ñ„Ñ„. ÑƒÑ€-Ð¸Ð¹.
    prob = ODEProblem(cartpole!, u0, tspan, p)
    
    # Ð ÐµÑˆÐ°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ.
    sol = solve(prob, alg)
    if print_u
        println("ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑƒÐ³Ð¾Ð» ", u0[1])
        println("ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð½Ð°Ñ ÑÐ¸Ð»Ð° Ð²Ð¾Ð·Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ F ", p[1])
        println("Ð£Ð³Ð¾Ð» Î¸ Ð¿Ð¾ÑÐ»Ðµ Ð²Ð¾Ð·Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ: ", sol[1, end][1])
        println("Ð¡ÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑƒÐ³Ð»Ð° Ï‰ Ð¿Ð¾ÑÐ»Ðµ Ð²Ð¾Ð·Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ: ", sol[2, end])
        println("ÐŸÐ¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸ x Ð¿Ð¾ÑÐ»Ðµ Ð²Ð¾Ð·Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ: ", sol[3, end])
        println("Ð¡ÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ Ñ‚ÐµÐ»ÐµÐ¶ÐºÐ¸ v Ð¿Ð¾ÑÐ»Ðµ Ð²Ð¾Ð·Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ: ", sol[4, end])
    end

    return [sol[1, end], sol[2, end], sol[3, end], sol[4, end]], p[1]
end

function show_graphs(
    u0,
    show_x=true, 
    show_theta=true,
    show_crit=true
)
    # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¼Ð°ÑÑÐ¸Ð²Ð° Ð´Ð»Ñ Ð¾ÑÐ¸ X
    times = 0.0:0.02:100.0
    states_Tan_Yam7_theta = []
    states_Tan_Yam7_x = []
    u0_last = u0
    flag = false
    for i in 1:5001
        last_u4 = u0[4]
        if show_theta
            push!(states_Tan_Yam7_theta, u0[1])
        end
        if show_x        
            push!(states_Tan_Yam7_x, u0[3])
        end

        if !flag
            u0, p = test_model(Nothing, u0, TanYam7(), false, false)
        end

        if u0[1] > pi/2
            flag = true
            u0[1] = pi/2
            u0[4] = last_u4
        end
        if u0[1] < -pi/2
            flag = true
            u0[1] = -pi/2
            u0[4] = last_u4
        end
        
        if flag
            u0[3] += u0[4] * 0.02
        end
    end

    u0 = u0_last
    states_Vern7_theta = []
    states_Vern7_x = []
    flag = false

    for i in 1:5001
        last_u4 = u0[4]
        if show_theta
            push!(states_Vern7_theta, u0[1])
        end
        if show_x
            push!(states_Vern7_x, u0[3])
        end

        if !flag
            u0, p = test_model(Nothing, u0, Vern7(), false, false)
        end

        if u0[1] > pi/2
            flag = true
            u0[1] = pi/2
            u0[4] = last_u4
        end
        if u0[1] < -pi/2
            flag = true
            u0[1] = -pi/2
            u0[4] = last_u4
        end

        if flag
            u0[3] += u0[4] * 0.02
        end
    end

    # ÐŸÐ¾ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ðµ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¾Ð² theta.
    if show_theta
        plot(times, states_Tan_Yam7_theta, label="ÐÐ»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼ TanYam7", xlabel="t", ylabel="Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ theta", title="Ð“Ñ€Ð°Ñ„Ð¸ÐºÐ¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹ theta Ð¾Ñ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸")
        plot!(times, states_Vern7_theta, label="ÐÐ»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼ Vern7", color=:red)
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¾Ð².
        savefig("graphs_theta.png")
    end
    
    # ÐŸÐ¾ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ðµ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¾Ð² Ð´Ð»Ñ x.
    if show_x
        plot(times, states_Tan_Yam7_x, label="ÐÐ»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼ TanYam7", xlabel="t", ylabel="Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ x", title="Ð“Ñ€Ð°Ñ„Ð¸ÐºÐ¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹ x Ð¾Ñ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸")
        plot!(times, states_Vern7_x, label="ÐÐ»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼ Vern7", color=:red)
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¾Ð².
        savefig("graphs_x.png")
    end

    # ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð°.
    if show_crit
        println("ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° Ð´Ð»Ñ Tan_Yam7: " * string(sum(states_Tan_Yam7_theta .^ 2) * 0.02))
        println("ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° Ð´Ð»Ñ Vern7: " * string(sum(states_Vern7_theta .^ 2) * 0.02))
    end
end

#Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
model_path = "model.bson"
BSON.@load model_path model
println("ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð¸Ð· $model_path")

#Ð—Ð°Ð´Ð°ÐµÐ¼ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
u0 = Float32[pi/6, 0, 0, 0]

# Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¸ Ð´Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
show_graphs(u0)

u = u0
states_Tan_Yam7 = []
Î¸_Tan_Yam7 = []
X_Tan_Yam7 = []
P_Tan_Yam7 = []

# Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
p = Float32(0)
num_iter = 5000
t_arr = collect(range(0, step=0.02, length=num_iter))

# Ð¡Ñ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼
count = 0
for i in 1:num_iter
    global u
    global count
    global p
    push!(states_Tan_Yam7, u)
    push!(Î¸_Tan_Yam7, u[1])
    push!(X_Tan_Yam7, u[2])
    push!(P_Tan_Yam7, p)

    # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
    use = true

    # Ð•ÑÐ»Ð¸ ÑƒÐ³Ð¾Ð» Ð¾ÐºÐ¾Ð»Ð¾ Ð½ÑƒÐ»Ñ Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÑ‚ÑŒ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
    if (-0.025 < u[1] < 0.025) &&  (-0.05 < u[2] < 0.05)
        use = false
        count += 1
    end

    u, p = test_model(model, u, TanYam7(), use, false)

    if !(-pi/2 < u[1]  < pi/2)
        println("Î¸ = ", u[1], " p = ", p, " Ð¡Ð»Ð¾Ð¼Ð°Ð»Ð¾ÑÑŒ Ð½Ð° Ð¸Ñ‚ÐµÑ€Ð°Ñ†Ð¸Ð¸ ", i)
        break
    end
end

#Ð—Ð°Ð´Ð°ÐµÐ¼ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
u0 = Float32[pi/6, 0, 0, 0]
u = u0
Î¸_Vern7 = []
X_Vern7 = []
P_Vern7 = []

# Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
p = Float32(0)
num_iter = 5000

# Ð³Ñ€Ð°Ñ„Ð¸Ðº ÑÑ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
count = 0
for i in 1:num_iter
    global u
    global count
    global p
    push!(Î¸_Vern7, u[1])
    push!(X_Vern7, u[2])
    push!(P_Vern7, p)

    # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
    use = true

    # Ð•ÑÐ»Ð¸ ÑƒÐ³Ð¾Ð» Ð¾ÐºÐ¾Ð»Ð¾ Ð½ÑƒÐ»Ñ Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÑ‚ÑŒ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
    if (-0.025 < u[1] < 0.025) &&  (-0.05 < u[2] < 0.05)
        use = false
        count += 1
    end

    u, p = test_model(model, u, Vern7(), use, false)


    if !(-pi/2 < u[1]  < pi/2)
        println("Î¸ = ", u[1], " p = ", p, " Ð¡Ð»Ð¾Ð¼Ð°Ð»Ð¾ÑÑŒ Ð½Ð° Ð¸Ñ‚ÐµÑ€Ð°Ñ†Ð¸Ð¸ ", i)
        break
    end
end

println("ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° Ð´Ð»Ñ Tan_Yam7: ", quality(Î¸_Tan_Yam7, P_Tan_Yam7))
println("ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° Ð´Ð»Ñ Vern7: ", quality(Î¸_Vern7, P_Vern7))

plot(t_arr, Î¸_Tan_Yam7, label="Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑƒÐ³Ð»Ð° Î¸ Ð´Ð»Ñ Tan_Yam7", title="Ð¡Ñ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ", xlabel="t", ylabel="Î¸", color=:red)
plot!(t_arr, Î¸_Vern7, label="Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑƒÐ³Ð»Ð° Î¸ Ð´Ð»Ñ Vern7", color=:blue)

# ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°
savefig("plot.png")

plot(t_arr, X_Tan_Yam7, label="Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ‚Ñ€Ð°ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Tan_Yam7", title="Ð¢Ñ€Ð°ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ", xlabel="t", ylabel="X", color=:red)
plot!(t_arr, X_Vern7, label="Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ‚Ñ€Ð°ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Vern7", color=:blue)

savefig("traectory.png")

plot(t_arr, P_Tan_Yam7, label="Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑÐ¸Ð»Ñ‹ Ð´Ð»Ñ Tan_Yam7", title="Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑÐ¸Ð»Ñ‹", xlabel="t", ylabel="X", color=:red)
plot!(t_arr, P_Vern7, label="Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑÐ¸Ð»Ñ‹ Ð´Ð»Ñ Vern7", color=:blue)

savefig("p.png")
